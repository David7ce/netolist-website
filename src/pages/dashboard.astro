---
import BaseLayout from "../layouts/BaseLayout.astro";
import { supabase } from "../config/supabaseClient";

const accessToken = Astro.cookies.get("sb-access-token")?.value;
const refreshToken = Astro.cookies.get("sb-refresh-token")?.value;

// Si no hay tokens, redirigir
if (!accessToken || !refreshToken) {
  return Astro.redirect("/sign-in");
}

// Intentar restaurar sesi√≥n
const { data, error } = await supabase.auth.setSession({
  access_token: accessToken,
  refresh_token: refreshToken,
});

// Si hay error al restaurar, redirigir al login
if (error || !data?.user) {
  Astro.cookies.delete("sb-access-token", { path: "/" });
  Astro.cookies.delete("sb-refresh-token", { path: "/" });
  return Astro.redirect("/sign-in");
}

const user = data.user;
---

<BaseLayout title="Dashboard" user={user}>
  <h1>Welcome to your dashboard, {user?.email || 'Guest'}!</h1>
  <p>You're successfully logged in!</p>

  <div class="info">
    <p>User ID: {user.id}</p>
    <p>Email: {user.email}</p>
  </div>

  <form action="/api/auth/signout" method="post">
    <button type="submit">Sign Out</button>
  </form>
</BaseLayout>
